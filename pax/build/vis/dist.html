<!DOCTYPE html>
<html>
<head>
	<title>Passenger Arrival Distribution</title>
	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/1.1.0/d3-legend.js"></script>
	<script src="data.js"></script>
	<style type="text/css">
	
		svg {
			padding: 50px;
		}

		body {
			font: 10px sans-serif;
		}

		path {
			fill: none;
			stroke-width: 2px;
		}

	</style>
</head>
<body>

	<script type="text/javascript">

		var outerWidth = 1000,
			outerHeight = 500,
			margin = { left: 50, top: 50, right: 50, bottom: 50};

		var xColumn = "x",
			yColumn = "y",
			colorColumn = "type";

		var innerWidth = outerWidth - margin.left - margin.right,
			innerHeight = outerHeight - margin.top - margin.bottom;

		var svg = d3.select("body").append("svg")
				.attr("width", outerWidth)
				.attr("height", outerHeight);

		var g = svg.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var xAxisG = g.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0,"+ innerHeight + ")");

		var yAxisG = g.append("g")
				.attr("class", "y axis")

		var colorLegendG = g.append("g")
				.attr("class", "color-legend")
				.attr("transform", "translate(500,0)");

		var xScale = d3.scale.linear().range([0,innerWidth]),
			yScale = d3.scale.linear().range([innerHeight, 0]),
			colorScale = d3.scale.ordinal()
				.range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

		var xAxis = d3.svg.axis().scale(xScale).orient("bottom")
				.outerTickSize(0)
				.ticks(20);

		var yAxis = d3.svg.axis().scale(yScale).orient("left")
				.outerTickSize(0);

		var line = d3.svg.line()
			.interpolate("basis") //monotone // step-before
			.x(function(d) { return xScale(d[xColumn]); })
			.y(function(d) { return yScale(d[yColumn]); })

		var colorLegend = d3.legend.color()
				.scale(colorScale)
				.shapePadding(3)
				.shapeWidth(15)
				.shapeHeight(15)
				.labelOffset(10)

		function render(data) {

			var nested = Object.keys(data).map(function(k) {
				return {
					"name" : k,
					"profiles" : Object.keys(data[k]).map(function(nk) {
						return {
							"di": nk,
							"values": Object.keys(data[k][nk]).map(function(nnk) {
								var profile = data[k][nk][nnk];
									spl = nnk.split('.')
								//profile.type = [spl[1], spl[3]].join('.');
								profile.type = [k,spl.slice(1).join('.')].join('.');
								return profile;
							})
						}
					})
				}
			});

			var flattened = nested.reduce(function(l,d) {
				for (var i=0; i<d.profiles.length; i++) {
					for (var j=0; j<d.profiles[i].values.length; j++) {
						l.push(d.profiles[i].values[j])
					}
				}
				return l;
			},[]).slice(0,6)

			var yDom = flattened.map(function(d) {
				return Object.keys(d.dist).map(function(k){
					return +d.dist[k];
				})
			}).reduce(function(l,d) {
				return l.concat(d);
			},[])

			xScale.domain( d3.extent([0,360]));
			yScale.domain( d3.extent(yDom));
			colorScale.domain( flattened.map( function(d) {	return d[colorColumn]; }));

			var lines = g.selectAll(".type")
				.data(flattened)
				.enter()
					.append("g")
					.attr("class", "type");

			lines.append("path")
				.attr("class", "line")
				.attr("d", function(d) {
					return line(Object.keys(d.dist).map(function(k) {
						return { 
							x : +k, 
							y : +d.dist[k] 
						}; 
					}))
				})
				.style("stroke", function(d) { return colorScale(d[colorColumn])})


			xAxisG.call(xAxis);
			yAxisG.call(yAxis);
			colorLegendG.call(colorLegend);


		}

		render(data)

	</script>

</body>
</html>